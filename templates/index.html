<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QQ Chat AI Analyzer</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>

    <!-- Top Navbar -->
    <nav class="navbar">
        <button class="nav-btn" onclick="toggleSidebar('left')">⚙️ API 配置</button>
        <button class="nav-btn" onclick="toggleSidebar('right')">🕒 历史记录</button>
        <button class="nav-btn" onclick="toggleModal('tutorial')">📖 使用教程</button>
    </nav>

    <!-- Left Sidebar: Configuration -->
    <aside id="sidebar-left" class="sidebar sidebar-left">
        <div class="sidebar-title">⚙️ API 参数配置</div>
        
        <div class="form-group">
            <label class="form-label">连接模式</label>
            <select id="llm-mode" class="form-select" onchange="toggleCustomConfig()">
                <option value="default">✅ 内置演示线路 (Mock)</option>
                <option value="custom">🔧 自定义 API Key</option>
            </select>
        </div>

        <div id="custom-config-area" style="display: none;">
            <div class="form-group">
                <label class="form-label">Base URL</label>
                <input type="text" id="api-base" class="form-input" value="https://api.openai.com/v1">
            </div>
            <div class="form-group">
                <label class="form-label">API Key</label>
                <input type="password" id="api-key" class="form-input" placeholder="sk-...">
            </div>
            <div class="form-group">
                <label class="form-label">默认模型</label>
                <input type="text" id="model-name" class="form-input" placeholder="例如: gpt-4o, deepseek-chat" value="gpt-4o">
            </div>
            
            <!-- Advanced Model Config -->
            <div class="form-group" style="background: #f8f9fa; padding: 10px; border-radius: 8px; border: 1px solid #eee;">
                <label class="form-label" style="color: var(--primary-color);">高级模型配置 (可选)</label>
                
                <label class="form-label" style="font-size: 0.8em; margin-top: 5px;">分块分析模型 (Map阶段)</label>
                <input type="text" id="model-map" class="form-input" placeholder="同默认模型">
                
                <label class="form-label" style="font-size: 0.8em; margin-top: 5px;">汇总报告模型 (Reduce阶段)</label>
                <input type="text" id="model-reduce" class="form-input" placeholder="同默认模型">
                
                <label class="form-label" style="font-size: 0.8em; margin-top: 5px;">修复美化模型 (Refine阶段)</label>
                <input type="text" id="model-refine" class="form-input" placeholder="同默认模型">
            </div>
        </div>

        <div class="sidebar-title" style="margin-top: 2rem;">🎛️ 分析参数</div>
        <div class="form-group">
            <label class="form-label">Token 预算 (128k - 950k) 
                <span title="Token 预算决定了发送给 AI 的上下文长度。预算越高，AI 看到的聊天记录越多，分析越全面，但消耗的时间和费用也会增加。" style="cursor:help; font-size:1rem;">💡</span>
            </label>
            <input type="range" id="sampling-strength" min="128000" max="950000" step="1000" value="128000" style="width:100%">
            <div style="text-align:right; font-size:0.8rem; color:#666;" id="token-val">128000</div>
            <p style="font-size: 0.75rem; color: #888; margin-top: 5px;">
                Token 是 AI 处理文本的基本单位（约 0.75 个单词或 1 个汉字）。<br>
                预算越高 = 分析越深入 + 费用越高。
            </p>
        </div>
        <div class="form-group">
            <label class="form-label">动漫小剧场主题</label>
            <select id="anime-theme" class="form-select" onchange="toggleCustomTheme()">
                <option value="default">✨ 自动匹配 (AI 决定)</option>
                <option value="bandream">🎸 BanG Dream! (MyGO/Ave Mujica)</option>
                <option value="gbc">🖕 Girls Band Cry (GBC)</option>
                <option value="custom">🖊️ 自定义主题</option>
            </select>
        </div>

        <div id="custom-theme-area" class="form-group" style="display: none;">
            <label class="form-label">自定义主题提示词</label>
            <textarea id="custom-theme-prompt" class="form-input" rows="3" placeholder="例如：赛博朋克风格，所有人都被义体化了..."></textarea>
        </div>

        <div class="form-group" style="margin-top: 15px; border-top: 1px dashed #eee; padding-top: 10px;">
            <label class="form-label" style="display: flex; align-items: center; cursor: pointer;">
                <input type="checkbox" id="enhance-mode" style="margin-right: 8px;">
                <span>✨ 启用最终输出增强</span>
            </label>
            <p style="font-size: 0.75rem; color: #888; margin-top: 5px;">
                生成报告后，再次发送给 AI 进行 HTML 修复与 CSS 深度美化。会消耗额外的 Token 和时间。
            </p>
        </div>

        <div style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #eee;">
            <button class="btn-primary" onclick="saveConfig()" style="width: 100%; background-color: #4CAF50;">💾 保存配置到本地</button>
            <p style="font-size: 0.75rem; color: #ff4b4b; margin-top: 8px;">
                ⚠️ 注意：配置将以明文形式保存在本地 config.json 文件中，请确保您的使用环境安全。
            </p>
        </div>
    </aside>

    <!-- Right Sidebar: History -->
    <aside id="sidebar-right" class="sidebar sidebar-right">
        <div class="sidebar-title">🕒 分析历史记录</div>
        <div id="history-list">
            <!-- JS will populate this -->
            <div style="text-align:center; color:#999; margin-top:2rem;">加载中...</div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <div class="hero-title">QQ群年度报告分析仪</div>
        <div class="hero-subtitle"><i>人生到处知何似，应似飞鸿踏雪泥。</i></div>

        <!-- Upload Area -->
        <div id="upload-zone" class="upload-area">
            <div class="upload-icon">📂</div>
            <div class="upload-text">点击或拖拽上传 JSON 文件</div>
            <input type="file" id="file-input" accept=".json" style="display: none;">
        </div>

        <!-- Progress Area -->
        <div id="status-container" class="status-container">
            <div class="status-text">
                <span id="status-msg">正在准备...</span>
                <span id="status-percent">0%</span>
            </div>
            <div class="progress-bar-bg">
                <div id="progress-fill" class="progress-bar-fill"></div>
            </div>
            <div id="log-box" class="log-box"></div>
            
            <div id="result-actions" style="margin-top: 1rem; display: none;">
                <a id="download-btn" href="#" target="_blank" class="btn-primary" style="display:block; text-align:center; text-decoration:none;">📥 下载 HTML 报告</a>
            </div>
        </div>
    </main>

    <!-- Tutorial Modal -->
    <div id="modal-tutorial" class="modal-overlay">
        <div class="modal-content tutorial-modal-content">
            <button class="close-btn" onclick="toggleModal('tutorial')">&times;</button>
            <h2 style="color:var(--primary-color);">📖 使用教程</h2>
            <div class="tutorial-container">
                <div id="tutorial-output" class="markdown-body" style="height: 100%; overflow-y: auto; padding: 10px;"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="/static/js/script.js?v=3"></script>
</body>
</html>
